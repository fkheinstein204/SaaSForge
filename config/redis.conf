# Redis Configuration for SaaSForge
# SECURITY FIX: AOF persistence enabled for durability (Fix #17)
#
# @file        redis.conf
# @brief       Production-grade Redis configuration with AOF persistence
# @author      Heinstein F.
# @date        2025-11-15
#
# SECURITY NOTES:
# - AOF (Append-Only File) ensures data durability
# - Blacklisted tokens, OTP codes, and password reset tokens are persisted
# - In case of Redis restart, critical security data is not lost

# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================
bind 0.0.0.0
port 6379
protected-mode no  # Disabled in Docker network (use firewall for production)
timeout 300        # Close idle client connections after 300 seconds

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================
maxmemory 2gb
maxmemory-policy allkeys-lru  # Evict least recently used keys when memory full

# ============================================================================
# PERSISTENCE (AOF - Append-Only File)
# ============================================================================

# CRITICAL SECURITY FIX: Enable AOF for data durability
appendonly yes
appendfilename "appendonly.aof"

# AOF fsync policy:
# - always: Fsync after every write (slowest, most durable)
# - everysec: Fsync every second (good balance - RECOMMENDED)
# - no: Let OS handle fsync (fastest, least durable)
appendfsync everysec

# Rewrite AOF when it grows by 100% and is at least 64MB
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Don't fsync during AOF rewrite (improves performance)
no-appendfsync-on-rewrite no

# Load AOF on startup (preferred over RDB for durability)
aof-load-truncated yes

# Use mixed RDB+AOF format for faster restarts
aof-use-rdb-preamble yes

# ============================================================================
# OPTIONAL RDB SNAPSHOTS (Secondary Backup)
# ============================================================================

# Disable RDB snapshots since AOF provides better durability
# Uncomment these for additional point-in-time backups:
# save 900 1      # Save after 900 seconds if at least 1 key changed
# save 300 10     # Save after 300 seconds if at least 10 keys changed
# save 60 10000   # Save after 60 seconds if at least 10000 keys changed

save ""  # Disable RDB snapshots

# ============================================================================
# SECURITY
# ============================================================================

# Disable dangerous commands (use RENAME-COMMAND for production)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# Require password authentication (set via environment variable in production)
# requirepass your_strong_password_here

# ============================================================================
# LOGGING
# ============================================================================
loglevel notice
logfile ""  # Log to stdout for Docker

# ============================================================================
# SLOW LOG
# ============================================================================
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128            # Keep last 128 slow queries

# ============================================================================
# REPLICATION (for future HA setup)
# ============================================================================
# Uncomment for Redis Sentinel or Cluster:
# replica-read-only yes
# min-replicas-to-write 1
# min-replicas-max-lag 10
