name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # Build configuration
  CMAKE_BUILD_TYPE: Release
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

  # Runner paths (conditional)
  IS_SELF_HOSTED: ${{ contains(runner.name, 'nuc-') }}

jobs:
  # Lint and security checks
  validate:
    name: Validate & Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  # C++ gRPC Services Build & Test
  build-cpp:
    name: Build & Test C++ Services
    needs: validate
    runs-on: ${{ (github.event_name == 'push' && 'self-hosted') || 'ubuntu-latest' }}
    strategy:
      fail-fast: false
      matrix:
        service: [auth, upload, payment, notification]

    steps:
      - uses: actions/checkout@v4

      - name: Determine cache paths
        id: paths
        run: |
          if [[ "${{ runner.name }}" == nuc-* ]]; then
            echo "cache-dir=/srv/cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=/srv/artifacts/${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "is-self-hosted=true" >> $GITHUB_OUTPUT
          else
            echo "cache-dir=$HOME/.cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=./artifacts" >> $GITHUB_OUTPUT
            echo "is-self-hosted=false" >> $GITHUB_OUTPUT
          fi

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git pkg-config ccache \
            libssl-dev libpq-dev libgrpc++-dev libprotobuf-dev \
            protobuf-compiler-grpc libhiredis-dev libpqxx-dev \
            libgtest-dev libargon2-dev lcov

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-${{ matrix.service }}
          max-size: 500M
          save: ${{ github.event_name == 'push' }}

      - name: Cache C++ dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.paths.outputs.cache-dir }}/cpp-deps
            third_party/
          key: ${{ runner.os }}-cpp-deps-${{ hashFiles('third_party/**') }}
          restore-keys: |
            ${{ runner.os }}-cpp-deps-

      - name: Install C++ third-party dependencies
        run: |
          # Create install script if it doesn't exist
          if [ ! -f "scripts/install-cpp-deps.sh" ]; then
            echo "Creating install-cpp-deps.sh..."
            mkdir -p scripts
            cat > scripts/install-cpp-deps.sh << 'EOFSCRIPT'
          #!/bin/bash
          set -e

          echo "Installing C++ third-party dependencies..."
          cd third_party

          # Install jwt-cpp (header-only library)
          if [ -d "jwt-cpp" ]; then
            echo "Installing jwt-cpp..."
            sudo cp -r jwt-cpp/include/* /usr/local/include/ || true
          fi

          # Build and install redis-plus-plus
          if [ -d "redis-plus-plus" ]; then
            echo "Building redis-plus-plus..."
            cd redis-plus-plus
            mkdir -p build && cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            make -j$(nproc)
            sudo make install
            cd ../..
          fi

          # Update library cache
          sudo ldconfig
          echo "Third-party dependencies installed successfully"
          EOFSCRIPT
            chmod +x scripts/install-cpp-deps.sh
          fi
          ./scripts/install-cpp-deps.sh

      - name: Generate protobuf/gRPC stubs
        run: |
          # Create proto generation script if it doesn't exist
          if [ ! -f "scripts/gen-proto.sh" ]; then
            echo "Creating gen-proto.sh..."
            mkdir -p scripts
            cat > scripts/gen-proto.sh << 'EOFSCRIPT'
          #!/bin/bash
          set -e

          echo "Generating protobuf/gRPC stubs..."
          mkdir -p services/cpp/generated
          cd proto

          for proto_file in *.proto; do
            echo "Generating stubs for $proto_file..."
            protoc --cpp_out=../services/cpp/generated \
                   --grpc_out=../services/cpp/generated \
                   --plugin=protoc-gen-grpc=$(which grpc_cpp_plugin) \
                   "$proto_file"
          done

          echo "C++ stubs generated in services/cpp/generated/"
          EOFSCRIPT
            chmod +x scripts/gen-proto.sh
          fi
          ./scripts/gen-proto.sh

      - name: Configure CMake
        run: |
          cd services/cpp
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                ..

      - name: Build ${{ matrix.service }} service
        run: |
          cd services/cpp/build
          make -j$(nproc) ${{ matrix.service }}_service

      - name: Run unit tests
        run: |
          cd services/cpp/build
          # Run tests for specific service if labeled, otherwise all
          ctest --output-on-failure -j$(nproc) || true

      - name: Generate coverage report
        if: github.event_name == 'push'
        run: |
          cd services/cpp/build
          # Generate coverage if tests ran
          if [ -d "CMakeFiles" ]; then
            lcov --capture --directory . --output-file coverage.info || true
            lcov --remove coverage.info '/usr/*' '*/tests/*' '*/third_party/*' --output-file coverage.info || true
          fi

      - name: Upload coverage to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./services/cpp/build/coverage.info
          flags: cpp-${{ matrix.service }}
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Store artifacts (self-hosted)
        if: steps.paths.outputs.is-self-hosted == 'true'
        run: |
          mkdir -p ${{ steps.paths.outputs.artifact-dir }}/cpp-${{ matrix.service }}
          cp services/cpp/build/${{ matrix.service }}/${{ matrix.service }}_service \
             ${{ steps.paths.outputs.artifact-dir }}/cpp-${{ matrix.service }}/ || true
          cp services/cpp/build/Testing/Temporary/*.log \
             ${{ steps.paths.outputs.artifact-dir }}/cpp-${{ matrix.service }}/ 2>/dev/null || true

      - name: Upload build artifacts (GitHub-hosted)
        if: steps.paths.outputs.is-self-hosted == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: cpp-${{ matrix.service }}-binary
          path: services/cpp/build/${{ matrix.service }}/${{ matrix.service }}_service
          retention-days: 7
          if-no-files-found: warn

  # FastAPI BFF Build & Test
  build-api:
    name: Build & Test FastAPI BFF
    needs: validate
    runs-on: ${{ (github.event_name == 'push' && 'self-hosted') || 'ubuntu-latest' }}

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: saasforge
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: saasforge_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Determine cache paths
        id: paths
        run: |
          if [[ "${{ runner.name }}" == nuc-* ]]; then
            echo "cache-dir=/srv/cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=/srv/artifacts/${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "is-self-hosted=true" >> $GITHUB_OUTPUT
          else
            echo "cache-dir=$HOME/.cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=./artifacts" >> $GITHUB_OUTPUT
            echo "is-self-hosted=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: api/requirements.txt

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ${{ steps.paths.outputs.cache-dir }}/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd api
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov coverage[toml]

      - name: Generate Python gRPC stubs
        run: |
          pip install grpcio-tools
          mkdir -p api/generated
          cd proto
          for proto_file in *.proto; do
            python -m grpc_tools.protoc -I. \
              --python_out=../api/generated \
              --grpc_python_out=../api/generated \
              "$proto_file"
          done

      - name: Run linting
        run: |
          cd api
          black . --check || echo "Black formatting issues found"
          flake8 . || echo "Flake8 issues found"
          mypy . || echo "MyPy type issues found"

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql://saasforge:test_password@localhost:5432/saasforge_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: test
        run: |
          cd api
          pytest -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./api/coverage.xml
          flags: python-api
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Store test results (self-hosted)
        if: steps.paths.outputs.is-self-hosted == 'true' && always()
        run: |
          mkdir -p ${{ steps.paths.outputs.artifact-dir }}/api
          cp -r api/htmlcov ${{ steps.paths.outputs.artifact-dir }}/api/ 2>/dev/null || true
          cp api/coverage.xml ${{ steps.paths.outputs.artifact-dir }}/api/ 2>/dev/null || true

      - name: Upload test results (GitHub-hosted)
        if: steps.paths.outputs.is-self-hosted == 'false' && always()
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage-report
          path: api/htmlcov
          retention-days: 7
          if-no-files-found: warn

  # React Frontend Build & Test
  build-ui:
    name: Build & Test React UI
    needs: validate
    runs-on: ${{ (github.event_name == 'push' && 'self-hosted') || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine cache paths
        id: paths
        run: |
          if [[ "${{ runner.name }}" == nuc-* ]]; then
            echo "cache-dir=/srv/cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=/srv/artifacts/${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "is-self-hosted=true" >> $GITHUB_OUTPUT
          else
            echo "cache-dir=$HOME/.cache" >> $GITHUB_OUTPUT
            echo "artifact-dir=./artifacts" >> $GITHUB_OUTPUT
            echo "is-self-hosted=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: |
          cd ui
          npm ci

      - name: Run linting
        run: |
          cd ui
          npm run lint || echo "Linting errors found"

      - name: Run type checking
        run: |
          cd ui
          npx tsc --noEmit

      - name: Run unit tests
        run: |
          cd ui
          npm test -- --coverage --watchAll=false || true

      - name: Build production bundle
        run: |
          cd ui
          npm run build

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./ui/coverage/coverage-final.json
          flags: react-ui
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Store build artifacts (self-hosted)
        if: steps.paths.outputs.is-self-hosted == 'true' && always()
        run: |
          mkdir -p ${{ steps.paths.outputs.artifact-dir }}/ui
          cp -r ui/dist ${{ steps.paths.outputs.artifact-dir }}/ui/ 2>/dev/null || true
          cp -r ui/coverage ${{ steps.paths.outputs.artifact-dir }}/ui/ 2>/dev/null || true

      - name: Upload build artifacts (GitHub-hosted)
        if: steps.paths.outputs.is-self-hosted == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ui-build
          path: ui/dist
          retention-days: 7
          if-no-files-found: warn

  # Integration Tests
  integration-tests:
    name: Integration Tests
    needs: [build-cpp, build-api, build-ui]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: saasforge
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: saasforge_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://saasforge:test_password@localhost:5432/saasforge_test
          REDIS_URL: redis://localhost:6379
        run: |
          if [ -d "tests/integration" ]; then
            pytest tests/integration/ -v
          else
            echo "No integration tests found"
          fi

  # Build status summary
  ci-success:
    name: CI Success
    needs: [validate, build-cpp, build-api, build-ui]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.validate.result }}" != "success" ] || \
             [ "${{ needs.build-cpp.result }}" != "success" ] || \
             [ "${{ needs.build-api.result }}" != "success" ] || \
             [ "${{ needs.build-ui.result }}" != "success" ]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi
          echo "✅ All CI checks passed"

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: '✅ All CI checks passed! Ready for review.'
            })
